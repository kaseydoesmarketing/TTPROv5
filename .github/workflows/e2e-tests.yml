name: ðŸŽ­ E2E Authentication Tests

on:
  schedule:
    # Run E2E tests every 4 hours to catch regressions
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      run_youtube_tests:
        description: 'Run YouTube integration tests'
        required: false
        default: false
        type: boolean

jobs:
  e2e-authentication:
    name: ðŸ” Authentication Flow E2E
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    defaults:
      run:
        working-directory: ./e2e

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./e2e/package-lock.json

    - name: ðŸ“¦ Install dependencies
      run: |
        npm ci
        npx playwright install --with-deps ${{ matrix.browser }}

    - name: ðŸ”§ Configure test environment
      run: |
        cp .env.example .env
        echo "E2E_BASE_URL=https://titletesterpro.com" >> .env
        echo "E2E_API_BASE_URL=https://ttprov4-k58o.onrender.com" >> .env
        echo "E2E_RUN_YOUTUBE_TESTS=${{ github.event.inputs.run_youtube_tests || 'false' }}" >> .env
        echo "E2E_HEADLESS=true" >> .env
        echo "CI=true" >> .env

    - name: ðŸŽ­ Run authentication tests
      run: |
        npx playwright test auth-flow --project=${{ matrix.browser }} --reporter=github
      timeout-minutes: 15

    - name: ðŸ“º Run YouTube integration tests (if enabled)
      if: github.event.inputs.run_youtube_tests == 'true'
      run: |
        npx playwright test youtube-integration --project=${{ matrix.browser }} --reporter=github
      timeout-minutes: 10

    - name: ðŸ“¤ Upload test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: e2e-results-${{ matrix.browser }}
        path: |
          ./e2e/test-results/
          ./e2e/playwright-report/
        retention-days: 7

    - name: ðŸ“Š Test summary
      if: always()
      run: |
        echo "## ðŸŽ­ E2E Test Results (${{ matrix.browser }})" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Authentication Flow | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ github.event.inputs.run_youtube_tests }}" == "true" ]]; then
          echo "| YouTube Integration | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Browser**: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY

  security-check:
    name: ðŸ”’ Security & Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Security scan
      run: |
        echo "ðŸ” Running security checks..."
        
        # Check for hardcoded secrets
        if grep -r "AIzaSy" app/ --include="*.py" --exclude-dir=__pycache__; then
          echo "âŒ Found hardcoded Firebase API key in backend"
          exit 1
        fi
        
        if grep -r "sk_live_" app/ --include="*.py" --exclude-dir=__pycache__; then
          echo "âŒ Found hardcoded Stripe live key"
          exit 1
        fi
        
        echo "âœ… No hardcoded secrets found in backend"
        
        # Check frontend for secrets
        if grep -r "AIzaSy" marketing/app/ --include="*.tsx" --include="*.ts"; then
          echo "âŒ Found hardcoded Firebase API key in frontend"
          exit 1
        fi
        
        echo "âœ… No hardcoded secrets found in frontend"

    - name: ðŸ”’ HTTPS enforcement check
      run: |
        echo "ðŸ”’ Checking HTTPS enforcement..."
        
        # Check if HTTP redirects to HTTPS
        if curl -s -I "http://titletesterpro.com" | grep -q "301\|302"; then
          echo "âœ… HTTP properly redirects to HTTPS"
        else
          echo "âš ï¸ HTTP redirect behavior unclear"
        fi
        
        # Check security headers
        HEADERS=$(curl -s -I "https://titletesterpro.com")
        if echo "$HEADERS" | grep -q "Strict-Transport-Security"; then
          echo "âœ… HSTS header present"
        else
          echo "âš ï¸ HSTS header missing"
        fi

  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš¡ Basic performance test
      run: |
        echo "âš¡ Running basic performance checks..."
        
        # Test frontend loading time
        START_TIME=$(date +%s%N)
        curl -s -o /dev/null "https://titletesterpro.com"
        END_TIME=$(date +%s%N)
        FRONTEND_TIME=$(((END_TIME - START_TIME) / 1000000))
        
        echo "ðŸŽ¨ Frontend load time: ${FRONTEND_TIME}ms"
        
        # Test API response time
        START_TIME=$(date +%s%N)
        curl -s -o /dev/null "https://ttprov4-k58o.onrender.com/health"
        END_TIME=$(date +%s%N)
        API_TIME=$(((END_TIME - START_TIME) / 1000000))
        
        echo "ðŸ”§ API response time: ${API_TIME}ms"
        
        # Performance thresholds
        if [[ $FRONTEND_TIME -gt 5000 ]]; then
          echo "âš ï¸ Frontend loading slowly (>5s)"
        else
          echo "âœ… Frontend performance acceptable"
        fi
        
        if [[ $API_TIME -gt 2000 ]]; then
          echo "âš ï¸ API responding slowly (>2s)"
        else
          echo "âœ… API performance acceptable"
        fi

  report:
    name: ðŸ“Š Final Report
    runs-on: ubuntu-latest
    needs: [e2e-authentication, security-check, performance-check]
    if: always()

    steps:
    - name: ðŸ“Š Generate comprehensive report
      run: |
        echo "# ðŸš€ TitleTesterPro v5 - Automated Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“… Report Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŽ¯ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Category | Status | Details |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Authentication E2E | ${{ needs.e2e-authentication.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Cross-browser authentication flow |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security Check | ${{ needs.security-check.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Secret scanning & HTTPS enforcement |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ Performance Check | ${{ needs.performance-check.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Load time & API responsiveness |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸŒ Production Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¨ **Frontend**: https://titletesterpro.com" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ **Backend API**: https://ttprov4-k58o.onrender.com" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“º **Marketing**: https://marketing-j2jylh0kq-ttpro-live.vercel.app" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [[ "${{ needs.e2e-authentication.result }}" == "success" && "${{ needs.security-check.result }}" == "success" && "${{ needs.performance-check.result }}" == "success" ]]; then
          echo "## ðŸŽ‰ Overall Status: âœ… ALL GREEN" >> $GITHUB_STEP_SUMMARY
          echo "The TitleTesterPro v5 authentication system is fully functional!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Overall Status: âŒ ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Please review the details above." >> $GITHUB_STEP_SUMMARY
        fi